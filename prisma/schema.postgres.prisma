// This is your Prisma schema file

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "darwin"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ผู้ใช้งานระบบ
model User {
  id        String   @id @default(uuid())
  username  String   @unique
  password  String
  role      String   @default("user") // admin, user, viewer
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  purchases Purchase[]
  payments  Payment[]
}

// สมาชิก (เจ้าของสวน)
model Member {
  id             String   @id @default(uuid())
  code           String   @unique
  name           String
  idCard         String?
  phone          String?
  address        String?
  bankAccount    String?
  bankName       String?
  ownerPercent   Float    @default(100) // เปอร์เซ็นต์เจ้าของสวน
  tapperPercent  Float    @default(0) // เปอร์เซ็นต์คนตัด
  tapperId       String? // ID คนตัด (ถ้ามี)
  tapperName     String? // ชื่อคนตัด
  advanceBalance Float    @default(0) // ยอดเบิกเงินล่วงหน้า
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  purchases Purchase[]
  payments  Payment[]
}

// ประเภทสินค้ายาง
model ProductType {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String // น้ำยางสด, ยางแห้ง, เศษยาง
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchases     Purchase[]
  productPrices ProductPrice[]
}

// ราคาสินค้าตามประเภทประจำวัน
model ProductPrice {
  id            String   @id @default(uuid())
  date          DateTime // วันที่ตั้งราคา
  productTypeId String
  price         Float // ราคา (บาท/กก.)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  productType ProductType @relation(fields: [productTypeId], references: [id], onDelete: Cascade)

  @@unique([date, productTypeId]) // ป้องกันการตั้งราคาซ้ำในวันเดียวกัน
  @@index([date])
}

// การรับซื้อ
model Purchase {
  id            String   @id @default(uuid())
  purchaseNo    String
  date          DateTime @default(now())
  memberId      String
  productTypeId String
  userId        String

  // น้ำหนัก
  grossWeight     Float // น้ำหนักรวมภาชนะ (กก.)
  containerWeight Float @default(0) // น้ำหนักภาชนะ (กก.)
  netWeight       Float // น้ำหนักสุทธิ (กก.)

  // สำหรับน้ำยางสด
  rubberPercent Float? // %ยาง (DRC)
  dryWeight     Float // น้ำหนักแห้ง (กก.)

  // ราคา
  basePrice     Float // ราคาพื้นฐาน (บาท/กก.)
  adjustedPrice Float // ราคาหลังปรับตาม %ยาง
  bonusPrice    Float @default(0) // ราคาบวกพิเศษ
  finalPrice    Float // ราคาสุดท้าย (บาท/กก.)
  totalAmount   Float // ยอดเงินรวม

  // การแบ่ง %
  ownerAmount  Float // เงินเจ้าของสวน
  tapperAmount Float @default(0) // เงินคนตัด

  isPaid    Boolean  @default(false)
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  member      Member      @relation(fields: [memberId], references: [id])
  productType ProductType @relation(fields: [productTypeId], references: [id])
  user        User        @relation(fields: [userId], references: [id])
  paymentItems PaymentItem[]

  @@index([purchaseNo])
  @@index([date])
  @@index([memberId])
}

// ค่าใช้จ่ายประจำวัน
model Expense {
  id          String   @id @default(uuid())
  expenseNo   String   @unique
  date        DateTime @default(now())
  category    String // ค่าน้ำมัน, ค่าซ่อมรถ, ค่าคนงาน, อื่นๆ
  amount      Float
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
  @@index([category])
}

// ค่าบริการ (Service Fees)
model ServiceFee {
  id          String   @id @default(uuid())
  serviceFeeNo String  @unique
  purchaseNo  String? // Link to purchase transaction (same cart)
  date        DateTime @default(now())
  category    String // ประเภทค่าบริการ
  amount      Float // จำนวนเงิน (บวก)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
  @@index([purchaseNo])
  @@index([category])
}

// การจ่ายเงินให้สมาชิก
model Payment {
  id            String       @id @default(uuid())
  paymentNo     String       @unique
  date          DateTime     @default(now())
  memberId      String
  userId        String
  totalAmount   Float
  advanceDeduct Float        @default(0)
  netAmount     Float
  notes         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  member Member @relation(fields: [memberId], references: [id])
  user   User   @relation(fields: [userId], references: [id])
  items  PaymentItem[]

  @@index([date])
  @@index([memberId])
}

// รายการเชื่อมการจ่ายเงินกับรายการรับซื้อ
model PaymentItem {
  id         String   @id @default(uuid())
  paymentId  String
  purchaseId String

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  purchase Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([purchaseId])
}

// ตั้งค่าระบบ
model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

// ข้อมูลการสำรอง
model Backup {
  id          String   @id @default(uuid())
  fileName    String   @unique
  filePath    String
  fileSize    Int
  backupType  String   // "auto" or "manual"
  createdAt   DateTime @default(now())

  @@index([createdAt])
  @@index([backupType])
}
